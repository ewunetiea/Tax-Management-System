<p-toolbar>
    <ng-template pTemplate="start" *ngIf="announcmentPayload.role ==='ROLE_APPROVER' && announcement_type !='archived' ">
        <p-button 
        label="New" 
        icon="pi pi-plus" 
        severity="secondary" 
        class="mr-2" 
        (onClick)="openNew()" />
        <p-button 
        severity="secondary" 
        label="Delete" 
        icon="pi pi-trash" 
        outlined 
        (click)="deleteAnnouncements(selecteAnnouncements)"
        [disabled]="!selecteAnnouncements || !selecteAnnouncements.length" />
    </ng-template>

    <ng-template pTemplate="center">
        <div class="flex justify-center w-full">
            <p-breadcrumb [model]="items"></p-breadcrumb>
        </div>
    </ng-template>

    <ng-template pTemplate="end">
    </ng-template>
</p-toolbar>

<p-toast />
<p-table 
#dt
[value]="announcements"
 [rows]="5" 
 [columns]="cols" 
 [paginator]="true"
[globalFilterFields]="['title', 'message', 'created_date', 'expiry_date','audience']"
[tableStyle]="{ 'min-width': '75rem' }" 
[(selection)]="selecteAnnouncements" 
[rowHover]="true"
 dataKey="id"
 currentPageReportTemplate="Showing {first} to {last} of {totalRecords} announcements"
 [expandedRowKeys]="expandedRows" 
  (onRowExpand)="onRowExpand($event)"
  (onRowCollapse)="onRowCollapse($event)" [tableStyle]="{ 'min-width': '230rem' }"
  [showCurrentPageReport]="true"
  [rowsPerPageOptions]="[10, 20, 30]" 
  [size]="selectedSize">
    <ng-template #caption>
        <div class="flex items-center justify-between">
            <button 
            pButton 
            label="Clear" 
            class="p-button-outlined" 
            icon="pi pi-filter-slash" 
            (click)="clear(dt)">
        </button>
            <div class="flex justify-center mb-4">
                <p-selectbutton [options]="sizes" [(ngModel)]="selectedSize" [multiple]="false" optionLabel="name"  optionValue="value" />
            </div>

            <!-- <h2>  Manage Announcement</h2> -->
            <p-iconfield>
                <p-inputicon styleClass="pi pi-search" />
                <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Search..." />
            </p-iconfield>
        </div>
    </ng-template>

    <ng-template #header>
        <tr>
            <th style="width: 3rem"></th>
            <th style="width: 3rem"><p-tableHeaderCheckbox /></th>
            <th pSortableColumn="title" style="min-width: 16rem">
                Title
                <p-sortIcon field="title" />
            </th>

            <th pSortableColumn="audience" style="min-width: 10rem">
                Audience
                <p-sortIcon field="audience" />
            </th>

            <th pSortableColumn="created_date" style="min-width: 12rem">
                Posted  Date
                <p-sortIcon field="created_date" />
            </th>

            <th pSortableColumn="expary_date" style="min-width: 12rem">
                Expary Date
                <p-sortIcon field="expary_date" />
            </th>

            <th pSortableColumn="message" style="min-width: 8rem">
                Posted by
                <p-sortIcon field="message" />
            </th>
            <th style="min-width: 12rem" *ngIf="this.announcmentPayload.role ==='ROLE_APPROVER'"> Action</th>
        </tr>
    </ng-template>

    <ng-template #body let-announcement let-expanded="expanded">
        <tr>
            <td>
                <p-button 
                type="button" 
                pRipple 
                [pRowToggler]="announcement" 
                [text]="true" 
                [rounded]="true"
                [plain]="true" 
                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
            </td>
            <td><p-tableCheckbox [value]="announcement" /></td>
            <td>{{ announcement.title }}</td>
            <td>{{ announcement.audience }}</td>
            <td>{{ announcement.created_date | date:'yyyy-MM-dd' }}</td>
            <td>{{ announcement.expiry_date | date:'yyyy-MM-dd' }}</td>
            <td>{{ announcement.postedBy }}</td>
            <td *ngIf="this.announcmentPayload.role ==='ROLE_APPROVER'">
                <p-button 
                icon="pi pi-pencil" 
                class="mr-2" 
                [rounded]="true" 
                [outlined]="true"
                 pTooltip="Edit"
                tooltipPosition="bottom" 
                 (click)="editAnnouncement(announcement)" />
                <p-button 
                icon="pi pi-trash" 
                severity="danger"
                 [rounded]="true" 
                 [outlined]="true"
                 pTooltip="Delete"
                 tooltipPosition="bottom" 
                (click)="deleteAnnouncements(announcement)" />
            </td>
        </tr>
    </ng-template>
    <ng-template #expandedrow let-tax>
              <tr>
                <td colspan="18">
                  <div class="p-3">
                    <div class="flex p-fluid space-x-2 py-2">
                      <p-button
                      (click)="activeIndex1 = 0"
                      icon="pi pi-plus"
                      styleClass="p-button-raised p-button-rounded ml-2"
                      label="Attached File Details"
                      ></p-button>
                          <p-button
                          (click)="activeIndex1 = 1"
                          icon="pi pi-plus"
                          styleClass="p-button-raised p-button-rounded p-ml-2"
                          label="Message Detail"
                        ></p-button>
                        </div>

                    <p-tabView [(activeIndex)]="activeIndex1">
                      <p-tabPanel header="Attached File Details">
                        <div class="py-3 flex space-x-2">
                          <p-button 
                          *ngIf="tax.image"
                          [icon]="activeState[1] ? 'pi pi-minus' : 'pi pi-plus'" 
                          (click)="toggle(1)"
                          styleClass="p-button-text" 
                          label="Attached File">
                        </p-button>
                        </div>

                        <div class="flex gap-4 items-start mt-3">
                          <div *ngIf="tax.announcementFile?.length" class="border p-3 rounded mb-3">
                            <div class="flex flex-wrap gap-4">
                              <div *ngFor="let file of tax.announcementFile"  class="border p-3 rounded w-64 flex-shrink-0 flex flex-col items-center">
                                <ng-container *ngIf="file.fileType">
                                  <div *ngIf="file.fileType.startsWith('image/') && file.file">
                                    <div class="flex items-center">
                                      <img [src]="'data:' + file.fileType + ';base64,' + file.file"
                                      [alt]="file.fileName || 'Image'"
                                      class="max-h-64 object-contain rounded-lg mb-2 w-full cursor-pointer"
                                      (error)="onImageError($event)" />
                                      <i class="pi pi-eye cursor-pointer ml-2"
                                      (click)="openDialogImage()"
                                      title="Preview Image"></i>
                                    </div>
                                    <a class="btn-download ml-2" (click)="openDialogImage()">Preview</a>
                                    <a [href]="'data:' + file.fileType + ';base64,' + file.file" [download]="file.fileName" class="btn-download ml-2">Download</a>
                                    <p-dialog header="Image Preview" [(visible)]="isDialogVisible" [modal]="true" [responsive]="true">
                                      <img [src]="'data:' + file.fileType + ';base64,' + file.file"  [alt]="file.fileName || 'Preview Image'" class="dialog-image" />
                                      <p-footer>
                                        <button type="button" (click)="isDialogVisible = false">Close</button>
                                      </p-footer>
                                    </p-dialog>
                                  </div>
                                  <div class="flex flex-col gap-2 mb-2 justify-center" *ngIf="file.fileType === 'application/pdf' || file.pdfUrl">
                                    <div class="text-center font-medium">{{ file.fileName }}</div>
                                    <div class="flex gap-3 justify-center">
                                      <button class="p-button p-component p-button-sm" (click)="previewPdf(file)">Preview</button>
                                      <button class="p-button p-component p-button-sm" (click)="downloadPdf(file)">Download</button>
                                    </div>
                                  </div>
                                  <div *ngIf="file.fileType?.includes('word') && file.file" class="text-center text-blue-600 mb-2">
                                    <i class="pi pi-file-word text-4xl mb-2"></i>
                                    <span class="block text-sm truncate">{{ file.fileName}}</span>
                                    <button class="text-blue-500 underline text-sm mt-1 block" (click)="downloadWord(file)"> Download</button>
                                  </div>
                                  <span *ngIf="!file.file && !file.pdfUrl" class="text-gray-400 text-sm"> No File </span>
                                </ng-container>
                              </div>
                            </div>
                          </div>
                          <p-dialog [(visible)]="showPdfModal" modal="true" [style]="{width: '70%', height: '80%'}" (onHide)="closeModalPDF()">
                            <iframe *ngIf="selectedPdf" [src]="selectedPdf" class="w-full h-full"></iframe>
                          </p-dialog>
                          <p-dialog [(visible)]="showPdfModal" modal="true" [style]="{width: '70%', height: '80%'}" (onHide)="closeModalPDF()">
                            <iframe *ngIf="selectedPdf" [src]="selectedPdf" class="w-full h-full"></iframe>
                          </p-dialog>
                        </div>
                      </p-tabPanel>
                      <p-tabPanel header="Message Detail">
                         <div *ngIf="tax.message && activeState[0]" class="card p-3">
                          <textarea rows="5" cols="30" pTextarea [(ngModel)]="tax.message" fluid></textarea>
                        </div>
                      </p-tabPanel>
                    </p-tabView>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>

        <app-announcement-create-edit 
        [(visible)]="announcemetDialog" 
        [announcement]="announcement"
        (saved)="onAnnouncementSaved($event)"
        (cancel)="hideDialog()">
    </app-announcement-create-edit>

    
<p-dialog
    [(visible)]="announcemetDialog"
    [style]="{ width: '600px' }"
    header="Announcement Details"
    [modal]="true"
    styleClass="p-fluid"
    [maximizable]="true"
  >
    <ng-template pTemplate="content">
      <app-announcement-create-edit
        [passedAnnouncement]="outputAnnouncement" 
        (editedAnnouncement)="onDataChange($event)"
      ></app-announcement-create-edit>
    </ng-template>
  </p-dialog>

    <p-dialog 
    [(visible)]="showPdfModal" 
    modal="true" 
    [style]="{width: '70%', height: '80%'}" 
    (onHide)="closeModal()">
    <iframe *ngIf="selectedPdf" 
    [src]="selectedPdf" class="w-full h-full"></iframe>
</p-dialog>

<p-confirmDialog header="Confirmation" icon="pi pi-exclamation-triangle"></p-confirmDialog>


