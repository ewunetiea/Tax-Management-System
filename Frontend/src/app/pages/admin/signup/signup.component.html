<div class="area">
  <p-toast></p-toast>
  <main>
    <div class="w-full max-w-6xl mx-auto px-4">
      <section class="min-h-screen flex flex-col items-center justify-center py-4">
       <div class="w-full max-w-6xl m-auto px-4">
         <div class="flex flex-wrap justify-content-center align-items-start gap-3">
            <div class="w-full md:w-6/12 lg:w-5/12 flex flex-column align-items-center justify-content-center">
              <div class="bg-white shadow-md rounded-md p-4 mb-3 z-20">
                <div class="flex justify-center">
                  <a routerLink="/" class="flex items-center w-auto">
                    <img
                      class="w-full text-center awash-bank-login-logo"
                      src="assets/img/Awash_Bank_Final_logo.jpg"
                      alt="Awash Bank AFRFMS"
                    />
                  </a>
                </div>
                <div *ngIf="!account_created; else afterAccountCreated" class="p-4 mt-negative-13">
                  <div class="pb-2">
                    <h5 class="text-center text-xl font-semibold mb-2">Create an Account</h5>
                    <p class="text-center text-sm">Enter your personal details to create account</p>
                  </div>
                  <form ngNativeValidate #userForm="ngForm" class="space-y-4">
                    <div class="flex flex-col gap-2">
                      <label for="employee_id"><strong class="text-red-600">*</strong>Awash Bank ID</label>
                      <input
                      pInputText
                        type="text"
                        #employee_id="ngModel"
                       [ngClass]="{'border-red-500': employee_id.invalid && employee_id.touched }"
                        id="employee_id"
                        placeholder="Staff ID"
                        [(ngModel)]="user.employee_id"
                        name="employee_id"
                        (blur)="checkAwashBankIdStatus($event)"
                        required="true"
                        pattern="^(AB|AIB)\/(\d{1,7})\/(19|20|21)\d{2}$"
                      />
                      <div *ngIf="employee_id.errors && employee_id.touched">
                        <small class="text-red-600" *ngIf="employee_id.errors['required']">Awash Bank ID is required</small>
                        <small class="text-red-600" *ngIf="employee_id.errors['pattern']">Awash ID Incorrect</small>
                      </div>
                      <div *ngIf="employee_id_status">
                        <small class="text-red-600">This ID Does not exist!</small>
                      </div>
                      <div *ngIf="employee_id_status_system">
                        <small class="text-red-600">User Already registered!</small>
                      </div>
                    </div>

                    <div
                      *ngIf="
                        !employee_id_status &&
                        !employee_id_status_system &&
                        proceed &&
                        !(employee_id.errors && employee_id.touched)
                      "
                      class="flex flex-col gap-2"
                    >
                      <label for="email"><strong class="text-red-600">*</strong>Outlook Address</label>
                      <input
                        type="text"
                        #email="ngModel"
                        [ngClass]="{'border-red-500': email.invalid && email.touched }"
                        pInputText
                        id="email"
                        [(ngModel)]="user.email"
                        name="email"
                        (blur)="checkEmailStatus($event)"
                        required="true"
                        pattern="\w+@awashbank\.com$"
                      />

                      <div *ngIf="email_status">
                        <small class="text-red-600">Outlook Address Already Exists </small>
                      </div>
                      <div *ngIf="email.errors && email.touched">
                        <small class="text-red-600" *ngIf="email.errors['required']" >Outlook Address is required</small >
                        <small class="text-red-600" *ngIf="email.errors['pattern']">Outlook Address should end with &#64;awashbank.com</small>
                      </div>
                    </div>

                    <div class="flex flex-col gap-2">
                      <label for="username"><strong class="text-red-600">*</strong>Fussion Essence Username</label>
                      <input
                        type="text"
                        #username="ngModel"
                        [ngClass]="{'border-red-500': username.invalid && username.touched }"
                        (blur)="checkUsernameStatus($event)"
                        pInputText
                        id="username"
                        [(ngModel)]="user.username"
                        name="username"
                        [required]="true"
                      />
                      <small
                        class="text-red-600"
                        [class.hidden]="username.valid || username.untouched"
                        >Username is required<br
                      /></small>

                      <div *ngIf="user_name_status">
                        <small class="text-red-600"> Username Already Exists </small>
                      </div>
                    </div>

                    <div class="flex flex-col gap-2">
                      <label for="first_name">First Name</label>
                      <input
                        type="text"
                        #first_name="ngModel"
                        [ngClass]="{'border-red-500': first_name.invalid && first_name.touched }"
                        pInputText
                        id="first_name"
                        [(ngModel)]="user.first_name"
                        name="first_name"
                      />
                    </div>
                    <div class="flex flex-col gap-2">
                      <label for="middle_name"> Middle Name</label>
                      <input
                        type="text"
                        #middle_name="ngModel"
                        [ngClass]="{'border-red-500': middle_name.invalid && middle_name.touched }"
                        pInputText
                        id="middle_name"
                        [(ngModel)]="user.middle_name"
                        name="middle_name"
                      />
                    </div>
                    <div class="flex flex-col gap-2">
                      <label for="last_name">Last Name</label>
                      <input
                        type="text"
                        #last_name="ngModel"
                        [ngClass]="{'border-red-500': last_name.invalid && last_name.touched }"
                        pInputText
                        id="last_name"
                        [(ngModel)]="user.last_name"
                        name="last_name"
                      />
                    </div>

                    <div class="flex flex-col gap-2">
                      <label class="p-mb-3"><strong class="text-red-600">*</strong>Gender</label>
                      <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex items-center">
                          <p-radioButton
                            id="male"
                            name="gender"
                            value="Male"
                            #gender="ngModel"
                            required="true"
                            [ngClass]="{'border-red-500': gender.invalid && gender.touched }"
                            [(ngModel)]="user.gender"
                          ></p-radioButton>
                          <label for="male">Male</label>
                        </div>
                        <div class="flex items-center">
                          <p-radioButton
                            id="female"
                            name="gender"
                            value="Female"
                            #gender="ngModel"
                            required="true"
                           [ngClass]="{'border-red-500': gender.invalid && gender.touched }"
                            [(ngModel)]="user.gender"
                          ></p-radioButton>
                          <label for="female">Female</label>
                        </div>
                        <small class="text-red-600" [class.hidden]="gender.valid || gender.untouched">Gender is required<br/></small>
                      </div>
                    </div>

                    <div class="flex flex-col gap-2">
                      <label for="phone_number">
                        <strong class="text-red-600">*</strong>Phone Number</label>
                      <input
                        type="tel"
                        #phone_number="ngModel"
                        [ngClass]="{'border-red-500': phone_number.invalid && phone_number.touched }"
                        pInputText
                        pattern="(\+251|0)(9|7)\d{8}"
                        id="phone_number"
                        (blur)="checkPhoneNumberStatus($event)"
                        [(ngModel)]="user.phone_number"
                        name="phone_number"
                        required="true"
                      />
                      <div *ngIf="phone_number_status">
                        <small class="text-red-600">Phone Number Already Exists</small>
                      </div>
                      <div *ngIf="phone_number.errors && phone_number.touched">
                        <small class="text-red-600" *ngIf="phone_number.errors['required']">Phone number is required</small>
                        <small class="text-red-600" *ngIf="phone_number.errors['pattern']">Phone number not valid or should start with +251, 09 or 07</small>
                      </div>
                    </div>

                    <div class="grid grid-cols-12 gap-4" *ngIf=" proceed && !(employee_id.errors && employee_id.touched) ">
                      <div class="w-full mb-4">
                        <label for="jobPosition">Job Title</label>
                        <p-dropdown
                          [options]="job_positions"
                          optionLabel="title"
                          inputId="jobPosition"
                          [disabled]="true"
                          name="jobPosition"
                          #job_position="ngModel"
                          [ngClass]="{'border-red-500': job_position.invalid && job_position.touched }"
                          [(ngModel)]="user.jobPosition"
                          placeholder="Select Job Title"
                          [filter]="true"
                          [virtualScroll]="true"
                          [virtualScrollItemSize]="38"
                        >
                        </p-dropdown>
                      </div>
                     <div class="w-full mb-4">
                        <label for="region">Region</label>
                        <p-dropdown
                          [options]="regions"
                          optionLabel="name"
                          name="region"
                          inputId="region"
                          [disabled]="true"
                          #region="ngModel"
                          [ngClass]="{'border-red-500': region.invalid && region.touched }"
                          [(ngModel)]="user.region"
                          [spellcheck]="true"
                          placeholder="Select Region"
                          [filter]="true"
                          filterValue="name"
                          filterPlaceholder="Filter by name"
                          [virtualScroll]="true"
                          [virtualScrollItemSize]="20"
                        >
                        </p-dropdown>
                      </div>

                      <div class="w-full mb-4">
                        <label for="branch">Unit</label>
                        <p-dropdown
                          [options]="allBranches"
                          optionLabel="name"
                          inputId="branch"
                          name="branch"
                          [disabled]="true"
                          #branch="ngModel"
                          [ngClass]="{'border-red-500': branch.invalid && branch.touched }"
                          [(ngModel)]="user.branch"
                          placeholder="Select Branch"
                          [filter]="true"
                          [virtualScroll]="true"
                          [virtualScrollItemSize]="38"
                        >
                        </p-dropdown>
                      </div>
                    </div>

                    <div class="flex flex-col gap-2" *ngIf="proceed">
                      <label class="mb-3"><strong class="text-red-600">*</strong>User Category</label>
                      <div class="flex flex-col md:flex-row gap-4">
                       <div class="col-span-4 flex items-center gap-2 mb-2">
                          <p-radioButton
                            id="is"
                            name="category"
                            value="IS"
                            #category="ngModel"
                            required="true"
                            [ngClass]="{'border-red-500': category.invalid && category.touched }"
                            [(ngModel)]="user.category"
                          ></p-radioButton>
                          <label for="is">IS</label>
                        </div>
                        <div class="col-span-4 flex items-center gap-2 mb-2">
                          <p-radioButton
                            id="mgt"
                            name="category"
                            value="MGT"
                            #category="ngModel"
                            required="true"
                            [ngClass]="{'border-red-500': category.invalid && category.touched }"
                            [(ngModel)]="user.category"
                          ></p-radioButton>
                          <label for="mgt">MGT</label>
                        </div>
                        <div class="col-span-4 flex items-center gap-2 mb-2">
                          <p-radioButton
                            id="branch_financial"
                            name="category"
                            value="BFA"
                            [(ngModel)]="user.category"
                            #category="ngModel"
                            required="true"
                            [ngClass]="{'border-red-500': category.invalid && category.touched }"
                          ></p-radioButton>
                          <label for="branch_financial">Financial</label>
                        </div>
                        <div class="col-span-4 flex items-center gap-2 mb-2">
                          <p-radioButton
                            id="inspection"
                            name="category"
                            value="INS"
                            [(ngModel)]="user.category"
                            #category="ngModel"
                            required="true"
                            [ngClass]="{'border-red-500': category.invalid && category.touched }"
                          ></p-radioButton>
                          <label for="inspection">Inspection</label>
                        </div>
                        <div class="col-span-4 flex items-center gap-2 mb-2">
                          <p-radioButton
                            id="general"
                            name="category"
                            value="GENERAL"
                            [(ngModel)]="user.category"
                            #category="ngModel"
                            required="true"
                            [ngClass]="{'border-red-500': category.invalid && category.touched }"
                          ></p-radioButton>
                          <label for="general">General</label>
                        </div>
                        <div class="col-span-4 flex items-center gap-2 mb-2">
                          <p-radioButton
                            id="admin"
                            name="admin"
                            value="ADMIN"
                            [(ngModel)]="user.category"
                            #category="ngModel"
                            required="true"
                            [ngClass]="{'border-red-500': category.invalid && category.touched }"
                          ></p-radioButton>
                          <label for="admin">Admin</label>
                        </div>
                        <small class="text-red-600" [class.hidden]="category.valid || category.untouched">User Category is required<br /></small>
                      </div>
                    </div>

                    <div class="flex flex-col gap-2"
                      *ngIf="(user.category == 'BFA' || user.category == 'INS') &&  proceed ">
                      <label class="mb-3"><strong class="text-red-600">*</strong>Banking Category</label>
                      <div class="grid grid-cols-12 gap-4">
                        <div class="col-span-4 flex items-center gap-2 mb-2">
                          <p-radioButton
                            id="conventional"
                            name="banking"
                            #banking="ngModel"
                            [ngClass]="{'border-red-500': banking.invalid && banking.touched }"
                            value="conventional"
                            required="true"
                            [(ngModel)]="user.banking"
                          ></p-radioButton>
                          <label for="conventional">Conventional</label>
                        </div>
                        <div class="col-span-4 flex items-center gap-2 mb-2">
                          <p-radioButton
                            id="ifb"
                            name="banking"
                            #banking="ngModel"
                            [ngClass]="{'border-red-500': banking.invalid && banking.touched }"
                            value="ifb"
                            required="true"
                            [(ngModel)]="user.banking"
                          ></p-radioButton>
                          <label for="ifb">IFB</label>
                        </div>
                        <small
                          class="text-red-600"
                          [class.hidden]="banking.valid || banking.untouched"
                          >Banking type is required<br
                        /></small>
                      </div>
                    </div>

                    <div
                      class="flex flex-col gap-2"
                      *ngIf="user.category == 'MGT' && proceed"
                    >
                      <label class="mb-3"><strong class="text-red-600">*</strong>Management Audit</label>
                      <div class="grid grid-cols-12 gap-4">
                        <div class="col-span-4 flex items-center gap-2 mb-2">
                          <p-radioButton
                            id="TradeService"
                            name="banking"
                            #banking="ngModel"
                            [ngClass]="{'border-red-500': banking.invalid && banking.touched }"
                            value="TradeService"
                            required="true"
                            [(ngModel)]="user.banking"
                          ></p-radioButton>
                          <label for="TradeService">Trade Service</label>
                        </div>
                        <div class="col-span-4 flex items-center gap-2 mb-2">
                          <p-radioButton
                            id="FinanceManagement"
                            name="banking"
                            #banking="ngModel"
                            [ngClass]="{'border-red-500': banking.invalid && banking.touched }"
                            value="FinanceManagement"
                            required="true"
                            [(ngModel)]="user.banking"
                          ></p-radioButton>
                          <label for="FinanceManagement">Finance Management</label>
                        </div>
                        <div class="col-span-4 flex items-center gap-2 mb-2">
                          <p-radioButton
                            id="PeriodicAudit"
                            name="banking"
                            #banking="ngModel"
                            [ngClass]="{'border-red-500': banking.invalid && banking.touched }"
                            value="PeriodicAudit"
                            required="true"
                            [(ngModel)]="user.banking"
                          ></p-radioButton>
                          <label for="PeriodicAudit">Periodic Audit</label>
                        </div>
                        <small
                          class="text-red-600"
                          [class.hidden]="banking.valid || banking.untouched"
                          >Management Audit type is required<br/></small>
                      </div>
                    </div>

                    <div class="grid grid-cols-12 gap-4" *ngIf="proceed">
                      <label class="ml-3"><strong class="text-red-600">*</strong>Authentication Media</label>
                      <div class="col-span-6 mb-1">
                        <p-selectButton
                          [options]="authenthicationOptions"
                          [(ngModel)]="user.authenthication_media"
                          optionLabel="label"
                          optionValue="value"
                          name="authenthication_media"
                          [required]="true"
                        >
                          <ng-template let-item>
                            <i [class]="item.icon"></i> </ng-template
                        ></p-selectButton>
                      </div>
                    </div>

                    <div class="grid grid-cols-12 gap-4 mt-4">
                      <div class="col-span-3 mb-2 mr-2">
                        <button
                          pButton
                          pRipple
                          label="Save"
                          [disabled]="
                            userForm.form.invalid ||
                            !proceed ||
                            phone_number_status ||
                            email_status ||
                            user_name_status
                          "
                          icon="pi pi-check"
                          class="p-button-raised p-button-rounded p-button-outlined"
                          (click)="openModal()"
                        ></button>
                      </div>
                      <div class="col-span-3">
                        <button
                          class="col-md-3"
                          pButton
                          pRipple
                          type="reset"
                          label="Reset"
                          icon="pi pi-times"
                          class="p-button-raised p-button-outlined p-button-danger p-button-rounded"
                        ></button>
                      </div>
                    </div>
                  </form>
                  <div class="w-full text-center mt-4">
                    <p class="text-sm mb-0">Already have an account? <a routerLink="/" class="text-primary underline">Log in</a></p>
                  </div>
                </div>
                <ng-template #afterAccountCreated>
                  <app-password-reset-otp
                    class="text-center"
                    [passedPhoneNumber]="user.phone_number"
                    (outputData)="onDataChange()"
                  ></app-password-reset-otp>
                </ng-template>
              </div>
              <!-- <div class="copyright">
                &copy; Copyright <strong><span>Awash Bank</span></strong>. All Rights Reserved
              </div> -->
            </div>
          </div>
        </div>
        <a
          (click)="scrollTop()"
          class="flex items-center justify-center back-to-top"
          ><i class="bi bi-arrow-up-short"></i
        ></a>
      </section>
    </div>
  </main>
  <ul class="circles">
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
  </ul>
</div>

<p-dialog
  [(visible)]="confrimationDialog"
  header="Confirm User's information"
  [modal]="true"
  styleClass="p-fluid"
  [maximizable]="true"
>
  <ng-template pTemplate="content">
    <div class="col-md-12">
      <label class="Form-label"
        >First name: <b>{{ user.first_name }}</b></label
      >
    </div>
    <div class="col-md-12">
      <label class="Form-label"
        >Middle name: <b>{{ user.middle_name }}</b></label
      >
    </div>
    <div class="col-md-12">
      <label class="Form-label"
        >Last name: <b>{{ user.last_name }}</b></label
      >
    </div>

    <div class="col-md-12">
      <label class="Form-label"
        >Username: <b>{{ user.username }}</b></label
      >
    </div>

    <div class="col-md-12">
      <label class="Form-label"
        >Gender: <b>{{ user.gender }}</b></label
      >
    </div>
    <div class="col-md-12">
      <label class="Form-label"
        >Phone number: <b>{{ user.phone_number }}</b></label
      >
    </div>
    <div class="col-md-12">
      <label class="Form-label"
        >Employee Id: <b>{{ user.employee_id }}</b></label
      >
    </div>
    <div class="col-md-12">
      <label class="Form-label"
        >Email address: <b>{{ user.email }}</b></label
      >
    </div>
    <div class="col-md-12">
      <label class="Form-label"
        >Job Title: <b>{{ user.jobPosition?.title }}</b></label
      >
    </div>
    <div class="col-md-12">
      <label class="Form-label" *ngIf="user.region?.name"
        >Place of Work: <b>{{ user.region?.name }}</b></label
      >
    </div>
    <div class="col-md-12">
      <label class="Form-label" *ngIf="user.branch?.name"
        >Place of Work: <b>{{ user.branch?.name }}</b></label
      >
    </div>
    <div class="col-md-12">
      <label class="Form-label"
        >User Category: <b>{{ user.category }}</b></label
      >
    </div>
    <div class="col-md-12">
      <label class="form-label"
        ><span *ngIf="user.category == 'BFA' || user.category == 'INS'"
          >Banking Category: </span
        ><span *ngIf="user.category == 'MGT'">Management Audit: </span>
        <b>{{ user.banking }}</b></label
      >
    </div>
    <div class="col-md-12">
      <label *ngIf="user.authenthication_media" class="Form-label"
        >Authentication Media: <b>{{ user.email }}</b></label
      >
      <label *ngIf="!user.authenthication_media" class="Form-label"
        >Authentication Media: <b>{{ user.phone_number }}</b></label
      >
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <button
      *ngIf="!loading"
      pButton
      pRipple
      label="Save"
      icon="pi pi-check"
      class="p-button-text"
      (click)="addUser()"
    ></button>
    <button *ngIf="loading" type="button" disabled class="btn btn-primary">
      Loading...

      <span
        class="spinner-border spinner-border-sm"
        role="status"
        aria-hidden="true"
      ></span>
    </button>
    <button
      pButton
      pRipple
      label="Cancel"
      icon="pi pi-times"
      class="p-button-text"
      (click)="hideDialog()"
    ></button>
  </ng-template>
</p-dialog>
