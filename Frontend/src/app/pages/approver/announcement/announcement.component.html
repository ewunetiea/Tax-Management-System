<p-toolbar>
    <ng-template pTemplate="start">
        <p-button label="New" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
        <p-button severity="secondary" label="Delete" icon="pi pi-trash" outlined
            (click)="deleteAnnouncements(selecteAnnouncements)"
            [disabled]="!selecteAnnouncements || !selecteAnnouncements.length" />
    </ng-template>

    <ng-template pTemplate="center">
        <div class="flex justify-center w-full">
            <p-breadcrumb [model]="items"></p-breadcrumb>
        </div>
    </ng-template>

    <ng-template pTemplate="end">
    </ng-template>
</p-toolbar>

<p-toast />
<p-table [expandedRowKeys]="expandedRows" (onRowExpand)="onRowExpand($event)" (onRowCollapse)="onRowCollapse($event)"
    #dt [value]="announcements" [rows]="5" [columns]="cols" [paginator]="true"
    [globalFilterFields]="['title', 'message', 'created_date', 'expiry_date','audience']"
    [tableStyle]="{ 'min-width': '75rem' }" [(selection)]="selecteAnnouncements" [rowHover]="true" dataKey="id"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} announcements" [showCurrentPageReport]="true"
    [rowsPerPageOptions]="[10, 20, 30]" [size]="selectedSize">
    <ng-template #caption>
        <div class="flex items-center justify-between">
            <button pButton label="Clear" class="p-button-outlined" icon="pi pi-filter-slash"
                (click)="clear(dt)"></button>


            <div class="flex justify-center mb-4">
                <p-selectbutton [options]="sizes" [(ngModel)]="selectedSize" [multiple]="false" optionLabel="name"
                    optionValue="value" />
            </div>


            <!-- <h2>  Manage Announcement</h2> -->
            <p-iconfield>
                <p-inputicon styleClass="pi pi-search" />
                <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Search..." />
            </p-iconfield>
        </div>
    </ng-template>

    <ng-template #header>
        <tr>
            <th style="width: 3rem"></th>

            <th style="width: 3rem"><p-tableHeaderCheckbox /></th>

            <th pSortableColumn="title" style="min-width: 16rem">
                Title
                <p-sortIcon field="title" />
            </th>


            <th pSortableColumn="audience" style="min-width: 10rem">
                Audience
                <p-sortIcon field="audience" />
            </th>




            <th pSortableColumn="created_date" style="min-width: 12rem">
                Created Date
                <p-sortIcon field="created_date" />
            </th>

            <th pSortableColumn="expary_date" style="min-width: 12rem">
                Expary Date

                <p-sortIcon field="expary_date" />
            </th>

            <th pSortableColumn="message" style="min-width: 8rem">
                CreatedBy / Auther
                <p-sortIcon field="message" />
            </th>
            <th style="min-width: 12rem"></th>
        </tr>
    </ng-template>

    <ng-template #body let-announcement let-expanded="expanded">
        <tr>
            <td>
                <p-button type="button" pRipple [pRowToggler]="announcement" [text]="true" [rounded]="true"
                    [plain]="true" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
            </td>
            <td><p-tableCheckbox [value]="announcement" /></td>
            <td>{{ announcement.title }}</td>
            <td>{{ announcement.audience }}</td>
            <td>{{ announcement.created_date | date:'yyyy-MM-dd' }}</td>
            <td>{{ announcement.expiry_date | date:'yyyy-MM-dd' }}</td>
            <td>{{ announcement.posted_by }}</td>
            <td>
                <p-button icon="pi pi-pencil" class="mr-2" [rounded]="true" [outlined]="true"
                    (click)="editAnnouncement(announcement)" />
                <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true"
                    (click)="deleteAnnouncements(announcement)" />
            </td>
        </tr>
    </ng-template>

    <ng-template #expandedrow let-announcement>
        <tr>
            <td colspan="9">
                <div class="p-3">
                    <div class="flex space-x-2 py-2">
                        <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-full px-4 py-2"
                            (click)="activeIndex1 = 0">
                            <i class="pi pi-plus mr-1"></i>Announcement Details
                        </button>
                    </div>

                    <p-tabView [(activeIndex)]="activeIndex1">
                        <p-tabPanel>
                            <div class="py-3 flex space-x-2">
                                <p-button *ngIf="announcement.message"
                                    [icon]="activeState[0] ? 'pi pi-minus' : 'pi pi-plus'" (click)="toggle(0)"
                                    styleClass="p-button-text" label="Message Detail"></p-button>

                                <p-button *ngIf="announcement.image"
                                    [icon]="activeState[1] ? 'pi pi-minus' : 'pi pi-plus'" (click)="toggle(1)"
                                    styleClass="p-button-text" label="Attached File"></p-button>
                            </div>

                            <!-- âœ… Message + Image side-by-side -->
                            <div class="flex gap-4 items-start mt-3">
                                <!-- Left: Message -->
                                <div class="flex-1" *ngIf="announcement.message && activeState[0]">
                                    <h6 class="font-bold mb-2 text-gray-700">Message</h6>

                                    <div
                                        class="w-full border rounded-md p-4 bg-surface-50 text-gray-700 whitespace-pre-wrap max-h-70 overflow-auto">
                                        {{ announcement.message }}
                                    </div>

                                    <!-- <textarea id="float-input" rows="6" [readOnly]="true" [value]="announcement.message"
                                        pInputTextarea class="w-full border rounded-md p-3 bg-surface-50"></textarea>                                                                            -->
                                </div>


                                <div class="border p-3 rounded mb-3" *ngIf="announcement.image && activeState[1]">
                                    <!-- Image -->
                                    <img *ngIf="announcement.fileType?.startsWith('image/')"
                                        [src]="'data:' + announcement.fileType + ';base64,' + announcement.image"
                                        alt="Image" class="max-h-64 object-contain rounded-lg" />

                                    <!-- PDF Buttons -->
                                    <div *ngIf="announcement.fileType === 'application/pdf'" class="flex gap-2">
                                        <button class="p-button p-component p-button-sm"
                                            (click)="previewPdf(announcement)">Preview PDF</button>
                                        <button class="p-button p-component p-button-sm"
                                            (click)="downloadPdf(announcement)">Download PDF</button>
                                    </div>

                                    <!-- Word -->
                                    <div *ngIf="announcement.fileType?.includes('word')"
                                        class="text-center text-blue-600">
                                        <i class="pi pi-file-word text-4xl mb-2"></i>
                                        <span>Word Document</span>
                                        <a [href]="'data:' + announcement.fileType + ';base64,' + announcement.image"
                                            download="document.docx" class="text-blue-500 underline text-sm mt-1">
                                            Download
                                        </a>
                                    </div>

                                    <!-- No File -->
                                    <span *ngIf="!announcement.image" class="text-gray-400">No File</span>
                                </div>


                                <!-- PDF Preview Modal -->
                                <p-dialog [(visible)]="showPdfModal" modal="true"
                                    [style]="{width: '70%', height: '80%'}" (onHide)="closeModal()">
                                    <iframe *ngIf="selectedPdf" [src]="selectedPdf" class="w-full h-full"></iframe>
                                </p-dialog>


                                <!-- Modal for PDF preview -->
                                <p-dialog [(visible)]="showPdfModal" modal="true"
                                    [style]="{width: '70%', height: '80%'}" (onHide)="closeModal()">
                                    <iframe *ngIf="selectedPdf" [src]="selectedPdf" class="w-full h-full"></iframe>
                                </p-dialog>


                            </div>
                        </p-tabPanel>
                    </p-tabView>
                </div>
            </td>
        </tr>
    </ng-template>

</p-table>


<app-announcement-create-edit [(visible)]="announcemetDialog" [announcement]="announcement"
    (saved)="onAnnouncementSaved($event)" (cancel)="hideDialog()"></app-announcement-create-edit>


<p-dialog [(visible)]="showPdfModal" modal="true" [style]="{width: '70%', height: '80%'}" (onHide)="closeModal()">
    <iframe *ngIf="selectedPdf" [src]="selectedPdf" class="w-full h-full"></iframe>
</p-dialog>


<p-confirmDialog header="Confirmation" icon="pi pi-exclamation-triangle"></p-confirmDialog>




<!-- <p-toolbar styleClass="mb-6">
    <ng-template #start>
        <p-button label="New" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
        <p-button severity="secondary" label="Delete" icon="pi pi-trash" outlined
            (onClick)="deleteSelectedAnnouncements()"
            [disabled]="!selecteAnnouncements || !selecteAnnouncements.length" />
    </ng-template>

    <ng-template #end>
        <p-button label="Export" icon="pi pi-upload" severity="secondary" (onClick)="exportCSV()" />
    </ng-template>
</p-toolbar>

<p-toast />

<div class="card">
    <p-dataview [value]="announcements" [rows]="19" [paginator]="true" layout="list">

        <ng-template #header>
            <h5 class="m-0">Manage Announcements</h5>
        </ng-template>

        <ng-template #list let-items>
            <div class="grid grid-cols-12 gap-4">
                <div class="col-span-12" *ngFor="let item of items; let first = first">

                    <div class="flex flex-col bg-white dark:bg-surface-800 p-4 rounded-lg shadow-lg"
                        [ngClass]="{ 'border-t border-surface-200 dark:border-surface-700': !first }">

                        <div class="flex justify-between items-center mb-2 p-2 rounded bg-gray-200 dark:bg-gray-600/80">
                            <div class="text-lg font-semibold text-surface-900 dark:text-surface-0">
                                Title: {{ item.title }}
                            </div>

                            <div class="flex items-center gap-2">
                                <span class="text-sm text-secondary">Audience: {{ item.audience }}</span>

                                <p-splitButton icon="pi pi-ellipsis-v" [model]="getActionItems(item)"
                                    styleClass="p-button-text p-button-rounded"></p-splitButton>
                            </div>
                        </div>

                        <div class="flex-1 text-surface-900 dark:text-surface-0 mb-3">
                            Message: {{ item.message }}
                        </div>

                        <div class="flex-1 text-surface-900 dark:text-surface-0 mb-3">
                            Message: {{ item.image }}
                        </div>

                        <div
                            class="flex justify-between text-xs text-surface-500 p-2 rounded bg-gray-50 dark:bg-gray-700/80">
                            <span>Announcement Posted Date: {{ item.created_date | date:'dd-MM-yyyy' }}</span>
                            <span>Announcement Expiry Date: {{ item.expiry_date | date:'dd-MM-yyyy' }}</span>
                        </div>

                    </div>
                </div>
            </div>
        </ng-template>
    </p-dataview>
</div> -->