package com.afr.fms.Auditee.Mapper;

import java.util.List;

import org.apache.ibatis.annotations.Delete;
import org.apache.ibatis.annotations.Many;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.One;
import org.apache.ibatis.annotations.Result;
import org.apache.ibatis.annotations.Results;
import org.apache.ibatis.annotations.Select;
import org.apache.ibatis.annotations.Update;

import com.afr.fms.Auditee.Entity.AuditeeDivisionFileISM;
import com.afr.fms.Auditee.Entity.AuditeeDivisionISM;
import com.afr.fms.Auditor.Entity.AuditISM;
import com.afr.fms.Auditor.Entity.IS_MGT_Auditee;

@Mapper
public interface AuditeeDivisionISMMapper {

	@Select("update Audtiee_Division_ISM set action_plan = #{action_plan} where id = #{id}")
	public Long add_response(AuditeeDivisionISM auditeeDivisionISM);

	@Select("insert into Audtiee_Division_ISM(division_id, IS_MGT_Auditee_id) values (#{division_id}, #{IS_MGT_Auditee_id})")
	public Long add_auditee_division_ism(Long division_id, Long IS_MGT_Auditee_id);

	@Delete("delete from Audtiee_Division_ISM where division_id = #{division_id} and IS_MGT_Auditee_id =  #{IS_MGT_Auditee_id}")
	public void delete_auditee_division_ism(Long division_id, Long IS_MGT_Auditee_id);

	@Select("insert into Auditee_Division_File_ISM(auditee_division_id, file_url) values(#{auditee_division_id}, #{file_url})")
	public Long add_attached_files(Long auditee_division_id, String file_url);

	@Select("select * from Audtiee_Division_ISM where IS_MGT_Auditee_id = #{IS_MGT_Auditee_id} and submitted_auditee = 1")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "division", column = "division_id", one = @One(select = "com.afr.fms.Admin.Mapper.BranchMapper.getBranchById")),
			@Result(property = "uploaded_files", column = "id", many = @Many(select = "com.afr.fms.Auditee.Mapper.AuditeeDivisionISMMapper.getAttachedFiles"))
	})
	public List<AuditeeDivisionISM> getAuditeeResponse(Long IS_MGT_Auditee_id);

	@Select("select * from Audtiee_Division_ISM where IS_MGT_Auditee_id = #{IS_MGT_Auditee_id}")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "division", column = "division_id", one = @One(select = "com.afr.fms.Admin.Mapper.BranchMapper.getBranchById")),
	})
	public List<AuditeeDivisionISM> getAssignedAuditeeDivisions(Long IS_MGT_Auditee_id);

		@Select("select * from Audtiee_Division_ISM where IS_MGT_Auditee_id = #{IS_MGT_Auditee_id} and division_id = #{division_id}")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "division", column = "division_id", one = @One(select = "com.afr.fms.Admin.Mapper.BranchMapper.getBranchById")),
	})
	public AuditeeDivisionISM getAssignedAuditeeDivisionsByAuditeeandDivisionID(Long IS_MGT_Auditee_id, Long division_id);

	@Select("select * from Audtiee_Division_ISM where division_id = #{division_id} and IS_MGT_Auditee_id = #{IS_MGT_Auditee_id}")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "division", column = "division_id", one = @One(select = "com.afr.fms.Admin.Mapper.BranchMapper.getBranchById")),
			@Result(property = "uploaded_files", column = "id", many = @Many(select = "com.afr.fms.Auditee.Mapper.AuditeeDivisionISMMapper.getAttachedFiles"))
	})
	public List<AuditeeDivisionISM> getAuditeeResponseByAuditeeandDivisionID(Long division_id, Long IS_MGT_Auditee_id);

	@Select("select * from Audtiee_Division_ISM where id = #{auditee_division_id}")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "division", column = "division_id", one = @One(select = "com.afr.fms.Admin.Mapper.BranchMapper.getBranchById")),
			@Result(property = "uploaded_files", column = "id", many = @Many(select = "com.afr.fms.Auditee.Mapper.AuditeeDivisionISMMapper.getAttachedFiles"))
	})
	public AuditeeDivisionISM getAuditeeResponseISM(Long auditee_division_id);

	@Select("select * from Auditee_Division_File_ISM where auditee_division_id = #{auditee_division_id}")
	@Results(value = {
	// @Result(property = "auditor", column = "auditor_id", one = @One(select =
	// "com.afr.fms.Admin.Mapper.UserMapper.getUserById")),
	// @Result(property = "auditees", column = "id", many = @Many(select =
	// "com.afr.fms.Admin.Mapper.AuditISMMapper.getISMAuditees"))
	})
	public List<AuditeeDivisionFileISM> getAttachedFiles(Long auditee_division_id);

	@Update("update Audtiee_Division_ISM set action_plan=#{action_plan} where id=#{id}")
	public void updateAuditeeResponse(AuditeeDivisionISM auditeeDivisionISM);

	@Update("update Audtiee_Division_ISM set submitted_auditee = 1  where id=#{auditeeDivision_id}")
	public void submitResponsetoAuditee(Long auditeeDivision_id);

	@Update("update IS_MGT_Auditee set complete_status = 1, completed_date = CURRENT_TIMESTAMP where id=#{auditee_id}")
	public void finishAuditeeResponse(Long auditee_id);

	@Update("update IS_Management_Audit set rectification_status = 0 where id=#{audit_id}")
	public void updateRectificationStatus(Long audit_id);

	@Delete("delete from Auditee_Division_File_ISM where auditee_division_id = #{auditee_division_id}")
	public void deleteAttachedFiles(Long auditee_division_id);

	@Select("select * from IS_Management_Audit where id in (select IS_MGT_id from IS_MGT_Auditee where auditee_id = #{auditee_id} and division_assigned = 0) and approve_status = 1 order by approved_date")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "auditor", column = "auditor_id", one = @One(select = "com.afr.fms.Admin.Mapper.UserMapper.getAuditorById")),
			// @Result(property = "IS_MGTAuditee", column = "id", many = @Many(select =
			// "com.afr.fms.Auditor.Mapper.AuditISMMapper.getISMAuditees")),
			@Result(property = "file_urls", column = "id", many = @Many(select = "com.afr.fms.Auditor.Mapper.UploadFileISMMapper.getFileUrlsByAuditID"))

	})
	public List<AuditISM> getAuditsForAuditee(Long auditee_id);

	@Select("select * from IS_Management_Audit where id in (select IS_MGT_id from IS_MGT_Auditee where id = #{auditee_id})")
	@Results(value = {
			@Result(property = "id", column = "id"),
	})
	public AuditISM getAuditByAuditeeID(Long auditee_id);

	@Update("update IS_Management_Audit set auditee_submitted = 1 where id = #{audit_id}")
	public void submitAuditAuditeeResponse(Long audit_id);

	@Select("select * from IS_Management_Audit where id in (select IS_MGT_id from IS_MGT_Auditee where auditee_id = #{auditee_id}) and rectification_status = 4 Order By rectification_date DESC")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "auditor", column = "auditor_id", one = @One(select = "com.afr.fms.Admin.Mapper.UserMapper.getAuditorById")),
			// @Result(property = "IS_MGTAuditee", column = "id", many = @Many(select =
			// "com.afr.fms.Auditor.Mapper.AuditISMMapper.getISMAuditees")),
			@Result(property = "file_urls", column = "id", many = @Many(select = "com.afr.fms.Auditor.Mapper.UploadFileISMMapper.getFileUrlsByAuditID"))

	})
	public List<AuditISM> getPartiallyRectifiedAuditsForAuditee(Long auditee_id);

	@Select("select * from IS_Management_Audit where rectification_status = 0  and id in (select IS_MGT_id from IS_MGT_Auditee where auditee_id = #{auditee_id} and complete_status != 1 and division_assigned = 1 )  "
			+ " Order By approved_date DESC")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "auditor", column = "auditor_id", one = @One(select = "com.afr.fms.Admin.Mapper.UserMapper.getAuditorById")),
			// @Result(property = "IS_MGTAuditee", column = "id", many = @Many(select =
			// "com.afr.fms.Auditor.Mapper.AuditISMMapper.getISMAuditees")),
			@Result(property = "file_urls", column = "id", many = @Many(select = "com.afr.fms.Auditor.Mapper.UploadFileISMMapper.getFileUrlsByAuditID"))

	})
	public List<AuditISM> getAuditsForAuditeeOnProgress(Long auditee_id);

	@Select("select * from IS_Management_Audit where id in (select IS_MGT_id from IS_MGT_Auditee where auditee_id = #{auditee_id}) and rectification_status = 2 "
			+ " Order By unrectification_date DESC")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "auditor", column = "auditor_id", one = @One(select = "com.afr.fms.Admin.Mapper.UserMapper.getAuditorById")),
			// @Result(property = "IS_MGTAuditee", column = "id", many = @Many(select =
			// "com.afr.fms.Auditor.Mapper.AuditISMMapper.getISMAuditees")),
			@Result(property = "file_urls", column = "id", many = @Many(select = "com.afr.fms.Auditor.Mapper.UploadFileISMMapper.getFileUrlsByAuditID"))

	})
	public List<AuditISM> getUnrectifiedAuditsForAuditee(Long auditee_id);

	@Select("select * from IS_Management_Audit where id in (select IS_MGT_id from IS_MGT_Auditee where auditee_id = #{auditee_id} and complete_status = 1) and response_added = 1 Order By responded_date DESC")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "auditor", column = "auditor_id", one = @One(select = "com.afr.fms.Admin.Mapper.UserMapper.getAuditorById")),
			// @Result(property = "IS_MGTAuditee", column = "id", many = @Many(select =
			// "com.afr.fms.Auditor.Mapper.AuditISMMapper.getISMAuditees")),
			@Result(property = "file_urls", column = "id", many = @Many(select = "com.afr.fms.Auditor.Mapper.UploadFileISMMapper.getFileUrlsByAuditID"))

	})
	public List<AuditISM> getRespondedAuditsForAuditee(Long auditee_id);

	@Select("select * from IS_Management_Audit where id in (select IS_MGT_id from IS_MGT_Auditee where  division_assigned = 1 and id in (select IS_MGT_Auditee_id from Audtiee_Division_ISM where division_id = #{division_id} and (response_submitted != 1)))   Order By approved_date")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "auditor", column = "auditor_id", one = @One(select = "com.afr.fms.Admin.Mapper.UserMapper.getUserById")),
			// @Result(property = "IS_MGTAuditee", column = "id", many = @Many(select =
			// "com.afr.fms.Auditor.Mapper.AuditISMMapper.getISMAuditees")),
			@Result(property = "file_urls", column = "id", many = @Many(select = "com.afr.fms.Auditor.Mapper.UploadFileISMMapper.getFileUrlsByAuditID"))

	})
	public List<AuditISM> getAuditsForAuditeeDivision(Long division_id);

	@Select("select * from IS_Management_Audit where id in (select IS_MGT_id from IS_MGT_Auditee where id in (select IS_MGT_Auditee_id from Audtiee_Division_ISM where division_id = #{division_id} ))  and rectification_status = 4 Order By rectification_date DESC")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "auditor", column = "auditor_id", one = @One(select = "com.afr.fms.Admin.Mapper.UserMapper.getUserById")),
			// @Result(property = "IS_MGTAuditee", column = "id", many = @Many(select =
			// "com.afr.fms.Auditor.Mapper.AuditISMMapper.getISMAuditees")),
			@Result(property = "file_urls", column = "id", many = @Many(select = "com.afr.fms.Auditor.Mapper.UploadFileISMMapper.getFileUrlsByAuditID"))

	})
	public List<AuditISM> getPartiallyRectifiedAuditsForAuditeeDivision(Long division_id);

	@Select("select * from IS_Management_Audit where id in (select IS_MGT_id from IS_MGT_Auditee where rectification_status = 0 and id in (select IS_MGT_Auditee_id from Audtiee_Division_ISM where division_id = #{division_id} and response_submitted = 1 and submitted_auditee != 1)) Order By approved_date")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "auditor", column = "auditor_id", one = @One(select = "com.afr.fms.Admin.Mapper.UserMapper.getUserById")),
			// @Result(property = "IS_MGTAuditee", column = "id", many = @Many(select =
			// "com.afr.fms.Auditor.Mapper.AuditISMMapper.getISMAuditees")),
			@Result(property = "file_urls", column = "id", many = @Many(select = "com.afr.fms.Auditor.Mapper.UploadFileISMMapper.getFileUrlsByAuditID"))

	})
	public List<AuditISM> getAuditsForAuditeeDivisionOnProgress(Long division_id);

	@Select("select * from IS_Management_Audit where rectification_status = 2 and  id in (select IS_MGT_id from IS_MGT_Auditee where id in (select IS_MGT_Auditee_id from Audtiee_Division_ISM where division_id = #{division_id})) Order By unrectification_date DESC")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "auditor", column = "auditor_id", one = @One(select = "com.afr.fms.Admin.Mapper.UserMapper.getUserById")),
			// @Result(property = "IS_MGTAuditee", column = "id", many = @Many(select =
			// "com.afr.fms.Auditor.Mapper.AuditISMMapper.getISMAuditees")),
			@Result(property = "file_urls", column = "id", many = @Many(select = "com.afr.fms.Auditor.Mapper.UploadFileISMMapper.getFileUrlsByAuditID"))
	})
	public List<AuditISM> getUnrectifiedAuditsForAuditeeDivision(Long division_id);

	@Select("select * from IS_Management_Audit where id in (select IS_MGT_id from IS_MGT_Auditee where id in (select IS_MGT_Auditee_id from Audtiee_Division_ISM where division_id = #{division_id})) and response_added = 1 Order By responded_date DESC")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "auditor", column = "auditor_id", one = @One(select = "com.afr.fms.Admin.Mapper.UserMapper.getUserById")),
			// @Result(property = "IS_MGTAuditee", column = "id", many = @Many(select =
			// "com.afr.fms.Auditor.Mapper.AuditISMMapper.getISMAuditees")),
			@Result(property = "file_urls", column = "id", many = @Many(select = "com.afr.fms.Auditor.Mapper.UploadFileISMMapper.getFileUrlsByAuditID"))

	})
	public List<AuditISM> getRespondedAuditsForAuditeeDivision(Long division_id);

	@Select("select * from IS_MGT_Auditee where IS_MGT_id = #{IS_MGT_id}")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "auditee_id", column = "auditee_id"),
			@Result(property = "auditee", column = "auditee_id", one = @One(select = "com.afr.fms.Admin.Mapper.BranchMapper.getBranchById")),
			@Result(property = "auditeeDivisionISM", column = "id", many = @Many(select = "com.afr.fms.Auditee.Mapper.AuditeeDivisionISMMapper.getAuditeeResponse")),
	})
	public List<IS_MGT_Auditee> getISMAuditees(Long IS_MGT_id);

	@Select("select * from IS_MGT_Auditee where IS_MGT_id = #{IS_MGT_id} and id in (Select IS_MGT_Auditee_id from Audtiee_Division_ISM where division_id = #{division_id})")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "auditee_id", column = "auditee_id"),
			@Result(property = "auditee", column = "auditee_id", one = @One(select = "com.afr.fms.Admin.Mapper.BranchMapper.getBranchById")),
	// @Result(property = "auditeeDivisionISM", column = "id", many = @Many(select =
	// "com.afr.fms.Auditee.Mapper.AuditeeDivisionISMMapper.getAuditeeResponse")),
	})
	public List<IS_MGT_Auditee> getISMAuditeeByAuditandDivisionID(Long IS_MGT_id, Long division_id);

	@Select("select * from IS_MGT_Auditee where auditee_id = #{auditee_id} and IS_MGT_id = #{IS_MGT_id}")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "auditee_id", column = "auditee_id"),
			@Result(property = "auditee", column = "auditee_id", one = @One(select = "com.afr.fms.Admin.Mapper.BranchMapper.getBranchById")),
			@Result(property = "auditeeDivisionISM", column = "id", many = @Many(select = "com.afr.fms.Auditee.Mapper.AuditeeDivisionISMMapper.getAuditeeResponse")),
	})
	public List<IS_MGT_Auditee> getISMAuditeesByAuditeeID(Long auditee_id, Long IS_MGT_id);

	@Select("select * from IS_MGT_Auditee where id = #{id}")
	@Results(value = {
			@Result(property = "id", column = "id"),
			@Result(property = "auditISM", column = "IS_MGT_id", one = @One(select = "com.afr.fms.Auditor.Mapper.AuditISMMapper.getAudit")),
			@Result(property = "auditee", column = "auditee_id", one = @One(select = "com.afr.fms.Admin.Mapper.BranchMapper.getBranchById")),
			@Result(property = "auditeeDivisionISM", column = "id", many = @Many(select = "com.afr.fms.Auditee.Mapper.AuditeeDivisionISMMapper.getAuditeeResponse")),
	})
	public IS_MGT_Auditee getISMAuditeeById(Long id);

	// @Update("update IS_Management_Audit set division_assigned = 1 where id=#{audit_id}")
	// public void updateDivisionAssignment(Long audit_id);	
	
	@Update("update IS_MGT_Auditee set division_assigned = 1 where id=#{audit_id}")
	public void updateDivisionAssignmentAuditee(Long audit_id);

	@Update("update IS_Management_Audit set division_assigned = 1 where id=#{audit_id}")
	public void updateDivisionAssignment(Long audit_id);

	// while division submitting its response to auditee
	@Update("update IS_Management_Audit set response_added = 1, responded_date=CURRENT_TIMESTAMP, finding_status='responded' where id=#{audit_id}")
	public void updateDivisionResponseStatus(Long audit_id);

	// while division uploading its response
	@Update("update Audtiee_Division_ISM set response_submitted = 1, submitted_auditee = 0, response_subimtted_date = CURRENT_TIMESTAMP where id = #{division_id};"
			+
			" update IS_MGT_Auditee set complete_status = 0 where id in (select IS_MGT_Auditee_id from Audtiee_Division_ISM where id = #{division_id});"
			+
			" update IS_Management_Audit set response_added = 0 where id in (select IS_MGT_id from IS_MGT_Auditee where id in (select IS_MGT_Auditee_id from Audtiee_Division_ISM where id = #{division_id}))")
	public void submitResponseStatus(Long division_id);

}
