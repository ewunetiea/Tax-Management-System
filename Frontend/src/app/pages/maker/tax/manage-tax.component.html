<p-toolbar>
    <ng-template pTemplate="start">
        <p-button label="New" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
        <p-button severity="secondary" label="Delete" icon="pi pi-trash" outlined (click)="deleteTaxes(selectedTaxes)"
            [disabled]="!selectedTaxes || !selectedTaxes.length" />
    </ng-template>

    <ng-template pTemplate="center">
        <div class="flex justify-center w-full">
            <p-breadcrumb [model]="items"></p-breadcrumb>
        </div>
    </ng-template>

    <ng-template pTemplate="end">
    </ng-template>
</p-toolbar>


<p-toast />
<p-table [expandedRowKeys]="expandedRows" (onRowExpand)="onRowExpand($event)" (onRowCollapse)="onRowCollapse($event)"
    #dt [value]="taxes" [loading]="loading" [rows]="5" [columns]="cols" [paginator]="true"
    [globalFilterFields]="['taxCategory', 'sendTo_', 'noOfEmployee', 'taxableAmount','taxWithHold', 'graduatetaxPool', 'incometaxPoolAmount', 'graduatetaxPool1',
     'graduaTotBasSalary','graduateTotaEmployee','graduatetaxWithHold', 'taxCategoryList','remark', 'maker_name','status', 'maker_date', 'initiator_branch', 'destination_branch']"
    [tableStyle]="{ 'min-width': '75rem' }" [(selection)]="selectedTaxes" [rowHover]="true" dataKey="id"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} taxes" [showCurrentPageReport]="true"
    [rowsPerPageOptions]="[10, 20, 30]" [size]="selectedSize">
    <ng-template #caption>
        <div class="flex items-center justify-between">
            <button pButton label="Clear" class="p-button-outlined" icon="pi pi-filter-slash"
                (click)="clear(dt)"></button>


            <div class="flex justify-center mb-4">
                <p-selectbutton [options]="sizes" [(ngModel)]="selectedSize" [multiple]="false" optionLabel="name"
                    optionValue="value" />
            </div>
            <p-iconfield>
                <p-inputicon styleClass="pi pi-search" />
                <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Search..." />
            </p-iconfield>
        </div>
    </ng-template>

    <ng-template #header>
        <tr>
            <th style="width: 3rem"></th>

            <th style="width: 3rem"><p-tableHeaderCheckbox /></th>


            <th pSortableColumn="from_" style="min-width: 12rem">
                Initietor Branch
                <p-sortIcon field="from_" />
            </th>


            <th pSortableColumn="from_" style="min-width: 12rem">
                Tax Reference Number
                <p-sortIcon field="reference_number" />
            </th>

            <th pSortableColumn="sendTo_" style="min-width: 12rem">
                Target Branch (Directorate)
                <p-sortIcon field="sendTo_" />
            </th>




            <th pSortableColumn="taxableAmount" style="min-width: 10rem">
                Taxable Amount
                <p-sortIcon field="taxableAmount" />
            </th>

            <th pSortableColumn="taxWithHold" style="min-width: 10rem">
                Tax With Hold
                <p-sortIcon field="taxWithHold" />
            </th>



            <th pSortableColumn="incometaxPoolAmount" style="min-width: 10rem">
                Income Tax Pool Amount
                <p-sortIcon field="incometaxPoolAmount" />
            </th>

            <th pSortableColumn="graduatetaxPool" style="min-width: 10rem">
                Graduate Taxpool
                <p-sortIcon field="graduatetaxPool" />
            </th>

            <th pSortableColumn="graduatetaxPool1" style="min-width: 10rem">
                Graduate Taxpool 1
                <p-sortIcon field="graduatetaxPool1" />
            </th>

            <th pSortableColumn="graduaTotBasSalary" style="min-width: 12rem">
                Graduate Total Base Salary
                <p-sortIcon field="graduaTotBasSalary" />
            </th>



            <th pSortableColumn="graduateTotaEmployee" style="min-width: 10rem">
                Graduate Total Employee
                <p-sortIcon field="graduateTotaEmployee" />
            </th>

            <th pSortableColumn="noOfEmployee" style="min-width: 10rem">
                Number of Employees
                <p-sortIcon field="noOfEmployee" />
            </th>

            <th pSortableColumn="graduatetaxWithHold" style="min-width: 10rem">
                Graduate Tax With Hold
                <p-sortIcon field="graduatetaxWithHold" />
            </th>

            <th pSortableColumn="taxCategory" style="min-width: 10rem">
                Tax Category
                <p-sortIcon field="taxCategory" />
            </th>

            <th pSortableColumn="maker_date" style="min-width: 12rem">
                Created Date
                <p-sortIcon field="maker_date" />
            </th>

            <th pSortableColumn="status" style="min-width: 10rem">
                Status
                <p-sortIcon field="status" />
            </th>

            <th pSortableColumn="status" style="min-width: 10rem">
                Action
                <p-sortIcon field="status" />
            </th>
            <th style="min-width: 12rem"></th>

            <th style="min-width: 12rem"></th>
        </tr>
    </ng-template>

    <ng-template #body let-tax let-expanded="expanded">
        <tr>
            <td>
                <p-button type="button" pRipple [pRowToggler]="tax" [text]="true" [rounded]="true" [plain]="true"
                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
            </td>
            <td><p-tableCheckbox [value]="tax" /></td>


            <td>{{ tax.initiator_branch }}</td>
            <td>{{ tax.reference_number }}</td>
            <td>{{ tax.destination_branch }}</td>
            <td>{{ tax.taxableAmount }}</td>
            <td>{{ tax.taxWithHold }}</td>
            <td>{{ tax.incometaxPoolAmount }}</td>
            <td>{{ tax.graduatetaxPool }}</td>
            <td>{{ tax.graduatetaxPool1 }}</td>
            <td>{{ tax.graduaTotBasSalary }}</td>
            <td>{{ tax.graduateTotaEmployee }}</td>
            <td>{{ tax.noOfEmployee }}</td>
            <td>{{ tax.graduatetaxWithHold }}</td>
            <td>{{ tax.taxCategory }}</td>
            <td>{{ tax.maker_date | date:'yyyy-MM-dd' }}</td>
            <td>{{ tax.status }}</td>
            <td>
                <p-button icon="pi pi-pencil" class="mr-2" [rounded]="true" [outlined]="true" (click)="editTax(tax)" />
                <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true"
                    (click)="deleteTaxes(tax)" />
            </td>
        </tr>
    </ng-template>

    <ng-template #expandedrow let-tax>
        <tr>
            <td colspan="9">
                <div class="p-3">
                    <div class="flex space-x-2 py-2">
                        <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-full px-4 py-2"
                            (click)="activeIndex1 = 0">
                            <i class="pi pi-plus mr-1"></i>Tax Details
                        </button>
                    </div>

                    <p-tabView [(activeIndex)]="activeIndex1">
                        <p-tabPanel>
                            <div class="py-3 flex space-x-2">
                                <p-button *ngIf="tax.message" [icon]="activeState[0] ? 'pi pi-minus' : 'pi pi-plus'"
                                    (click)="toggle(0)" styleClass="p-button-text" label="Message Detail"></p-button>

                                <p-button *ngIf="tax.image" [icon]="activeState[1] ? 'pi pi-minus' : 'pi pi-plus'"
                                    (click)="toggle(1)" styleClass="p-button-text" label="Attached File"></p-button>
                            </div>

                            <!-- âœ… Message + Image side-by-side -->
                            <div class="flex gap-4 items-start mt-3">
                                <!-- Left: Message -->
                                <div class="flex-1" *ngIf="tax.message && activeState[0]">
                                    <h6 class="font-bold mb-2 text-gray-700">Message</h6>

                                    <div
                                        class="w-full border rounded-md p-4 bg-surface-50 text-gray-700 whitespace-pre-wrap max-h-70 overflow-auto">
                                        {{ tax.message }}
                                    </div>
                                </div>

                             



                                <div *ngIf="tax.taxFile?.[0] " class="border p-3 rounded mb-3">
                                    <ng-container *ngIf="tax.taxFile[0].fileType">

                                        <!-- Image Display -->
                                        <img *ngIf="tax.taxFile[0].fileType.startsWith('image/') && tax.taxFile[0].file"
                                            [src]="'data:' + tax.taxFile[0].fileType + ';base64,' + tax.taxFile[0].file"
                                            alt="Image" class="max-h-64 object-contain rounded-lg" />

                                        <!-- PDF Buttons -->
                                        <div class="flex gap-2">
                                            <button class="p-button p-component p-button-sm"
                                                (click)="previewPdf(tax.taxFile[0])">
                                                Preview PDF
                                            </button>
                                            <button class="p-button p-component p-button-sm"
                                                (click)="downloadPdf(tax.taxFile[0])">
                                                Download PDF
                                            </button>
                                        </div>

                                        <!-- Word Document Display -->
                                        <div *ngIf="tax.taxFile[0].fileType?.includes('word') && tax.taxFile[0].file"
                                            class="text-center text-blue-600">
                                            <i class="pi pi-file-word text-4xl mb-2"></i>
                                            <span>Word Document</span>
                                            <a [href]="'data:' + tax.taxFile[0].fileType + ';base64,' + tax.taxFile[0].file"
                                                download="{{tax.taxFile[0].fileName}}"
                                                class="text-blue-500 underline text-sm mt-1">
                                                Download
                                            </a>
                                        </div>

                                        <span *ngIf="!tax.taxFile[0].file && !tax.taxFile[0].pdfUrl"
                                            class="text-gray-400">
                                            No File
                                        </span>
                                    </ng-container>
                                </div>

                                <!-- PDF Preview Dialog -->
                                <p-dialog [(visible)]="showPdfModal" modal="true"
                                    [style]="{width: '70%', height: '80%'}" (onHide)="closeModal()">
                                    <iframe *ngIf="selectedPdf" [src]="selectedPdf" class="w-full h-full"></iframe>
                                </p-dialog>

                                <!-- PDF Preview Modal -->
                                <!-- <p-dialog [(visible)]="showPdfModal" modal="true"
                                    [style]="{width: '70%', height: '80%'}" (onHide)="closeModal()">
                                    <iframe *ngIf="selectedPdf" [src]="selectedPdf" class="w-full h-full"></iframe>
                                </p-dialog> -->


                                <!-- Modal for PDF preview -->
                                <p-dialog [(visible)]="showPdfModal" modal="true"
                                    [style]="{width: '70%', height: '80%'}" (onHide)="closeModal()">
                                    <iframe *ngIf="selectedPdf" [src]="selectedPdf" class="w-full h-full"></iframe>
                                </p-dialog>


                            </div>
                        </p-tabPanel>
                    </p-tabView>
                </div>
            </td>
        </tr>
    </ng-template>

</p-table>


<app-tax-create-edit [(visible)]="taxDialog" [tax]="tax" (saved)="onTaxesaved($event)"
    (cancel)="hideDialog()"></app-tax-create-edit>


<p-dialog [(visible)]="showPdfModal" modal="true" [style]="{width: '70%', height: '80%'}" (onHide)="closeModal()">
    <iframe *ngIf="selectedPdf" [src]="selectedPdf" class="w-full h-full"></iframe>
</p-dialog>


<p-confirmDialog header="Confirmation" icon="pi pi-exclamation-triangle"></p-confirmDialog>